{
  "p": [
    "MAPREDUCE-5117",
    "With security enabled HS delegation token renewer fails"
  ],
  "(1) Log information": {
    "p": [
      "The following log comes from RM.",
      "2013-03-27 23:30:26,591ERRORorg.apache.hadoop.ipc.RPC: RPC.stopProxy called on non proxy.",
      "java.lang.IllegalArgumentException: not a proxy instance",
      "at java.lang.reflect.Proxy.getInvocationHandler(Proxy.java:637)",
      "at org.apache.hadoop.ipc.RPC.stopProxy(RPC.java:609)",
      "at org.apache.hadoop.mapreduce.v2.security.MRDelegationTokenRenewer.stopHistoryProxy(MRDelegationTokenRenewer.java:102)",
      "at org.apache.hadoop.mapreduce.v2.security.MRDelegationTokenRenewer.renew(MRDelegationTokenRenewer.java:71)",
      "at org.apache.hadoop.security.token.Token.renew(Token.java:372)",
      "at org.apache.hadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer$1.run(DelegationTokenRenewer.java:370)",
      "at org.apache.hadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer$1.run(DelegationTokenRenewer.java:367)",
      "at java.security.AccessController.doPrivileged(Native Method)",
      "at javax.security.auth.Subject.doAs(Subject.java:396)",
      "at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1478)",
      "at org.apachhadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer.renewToken(DelegationTokenRenewer.java:366)",
      "at org.apache.hadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer.addApplication(DelegationTokenRenewer.java:288)",
      "at org.apache.hadoop.yarn.server.resourcemanager.RMAppManager.submitApplication(RMAppManager.java:269)",
      "at org.apache.hadoop.yarn.server.resourcemanager.RMAppManager.handle(RMAppManager.java:353)",
      "at org.apache.hadoop.yarn.server.resourcemanager.ClientRMService.submitApplication(ClientRMService.java:279)",
      "at org.apache.hadoop.yarn.api.impl.pb.service.ClientRMProtocolPBServiceImpl.submitApplication(ClientRMProtocolPBServiceImpl.java:151)",
      "at org.apache.hadoop.yarn.proto.ClientRMProtocol$ClientRMProtocolService$2.callBlockingMethod(ClientRMProtocol.java:204)",
      "at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:454)",
      "at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:1014)",
      "at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1741)",
      "at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1737)",
      "at java.security.AccessController.doPrivileged(Native Method)",
      "at javax.security.auth.Subject.doAs(Subject.java:396)",
      "at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1478)",
      "at org.apache.hadoop.ipc.Server$Handler.run(Server.java:1735)",
      "2013-03-27 23:30:26,594WARNorg.apache.hadoop.ipc.Server: IPC Server handler 15 on 8032, call org.apache.hadoop.yarn.api.ClientRMProtocolPB.submitApplication from 10.46.37.244:36960: error: org.apache.hadoop.HadoopIllegalArgumentException: Cannot close proxy - is not Closeable or does not provide closeable invocation handler class org.apache.hadoop.mapreduce.v2.api.impl.pb.client.HSClientProtocolPBClientImpl",
      "org.apache.hadoop.HadoopIllegalArgumentException: Cannot close proxy - is not Closeable or does not provide closeable invocation handler class org.apache.hadoop.mapreduce.v2.api.impl.pb.client.HSClientProtocolPBClientImpl",
      "at org.apache.hadoop.ipc.RPC.stopProxy(RPC.java:624)",
      "at org.apache.hadoop.mapreduce.v2.security.MRDelegationTokenRenewer.stopHistoryProxy(MRDelegationTokenRenewer.java:102)",
      "at org.apache.hadoop.mapreduce.v2.security.MRDelegationTokenRenewer.renew(MRDelegationTokenRenewer.java:71)",
      "at org.apache.hadoop.security.token.Token.renew(Token.java:372)",
      "at org.apache.hadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer$1.run(DelegationTokenRenewer.java:370)",
      "at org.apache.hadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer$1.run(DelegationTokenRenewer.java:367)",
      "at java.security.AccessController.doPrivileged(Native Method)",
      "at javax.security.auth.Subject.doAs(Subject.java:396)",
      "at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1478)",
      "at org.apache.hadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer.renewToken(DelegationTokenRenewer.java:366)",
      "at org.apache.hadoop.yarn.server.resourcemanager.security.DelegationTokenRenewer.addApplication(DelegationTokenRenewer.java:288)",
      "at org.apache.hadoop.yarn.server.resourcemanager.RMAppManager.submitApplication(RMAppManager.java:269)",
      "at org.apache.hadoop.yarn.server.resourcemanager.RMAppManager.handle(RMAppManager.java:353)",
      "at org.apache.hadoop.yarn.server.resourcemanager.ClientRMService.submitApplication(ClientRMService.java:279)",
      "at org.apache.hadoop.yarn.api.impl.pb.service.ClientRMProtocolPBServiceImpl.submitApplication(ClientRMProtocolPBServiceImpl.java:151)",
      "at org.apache.hadoop.yarn.proto.ClientRMProtocol$ClientRMProtocolService$2.callBlockingMethod(ClientRMProtocol.java:204)",
      "at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:454)",
      "at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:1014)",
      "at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1741)",
      "at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1737)",
      "at java.security.AccessController.doPrivileged(Native Method)",
      "at javax.security.auth.Subject.doAs(Subject.java:396)",
      "at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1478)",
      "at org.apache.hadoop.ipc.Server$Handler.run(Server.java:1735)"
    ]
  },
  "(2) How to figure out the root cause based on logs": {
    "p": [
      "Based on the stack trace contained in the log, we see that the error happens when JobClient submitApplication to RM through RPC. Althogh the logs from JobClient are not provided, we can infer that the exception will also occur on JobClient.",
      "Combining the top frames of the stack trace and the source code, we can see the following call relationship. The ERROR and WARN are caused by the same error.",
      "",
      "in MRDelegationTokenRenewer.java",
      "public longrenew(Token<?> token, Configuration conf)throwsIOException, InterruptedException {",
      "...",
      "MRClientProtocol histProxy = instantiateHistoryProxy(conf,",
      "SecurityUtil.getTokenServiceAddr(token));",
      "try{",
      "RenewDelegationTokenRequest request = Records",
      ".newRecord(RenewDelegationTokenRequest.class);",
      "request.setDelegationToken(dToken);",
      "returnhistProxy.renewDelegationToken(request).getNextExpirationTime();",
      "}finally{",
      "stopHistoryProxy(histProxy);",
      "}",
      "}",
      "",
      "protected voidstopHistoryProxy(MRClientProtocol proxy) {",
      "RPC.stopProxy(proxy);",
      "}",
      "",
      "",
      "/**",
      "* Stop the proxy. Proxy must either implement {@linkCloseable} or must have",
      "* associated {@linkRpcInvocationHandler}.",
      "*/",
      "public static voidstopProxy(Object proxy) {in RPC.java",
      "if(proxy ==null) {",
      "throw newHadoopIllegalArgumentException(\"Cannot close proxy since it is null\");",
      "}",
      "try{",
      "if(proxyinstanceofCloseable) {",
      "((Closeable) proxy).close();",
      "return;",
      "}else{",
      "InvocationHandler handler = Proxy.getInvocationHandler(proxy);",
      "if(handlerinstanceofCloseable) {",
      "((Closeable) handler).close();",
      "return;",
      "}",
      "}",
      "}catch(IOException e) {",
      "LOG.error(\"Closing proxy or invocation handler caused exception\", e);",
      "}catch(IllegalArgumentException e) {",
      "LOG.error(\"RPC.stopProxy called on non proxy.\", e);",
      "}",
      "",
      "thrownewHadoopIllegalArgumentException(",
      "\"Cannot close proxy - is not Closeable or \"",
      "+\"does not provide closeable invocation handler \"",
      "+ proxy.getClass());",
      "}",
      "",
      "HSClientProtocolPBClientImpl should implement Closeable.",
      ""
    ]
  },
  "(3) Root Cause": {
    "p": [
      "MRClientProtocol is not implemented correctly, making the function call stopHistoryProxy failed and throwing exception.",
      ""
    ]
  },
  "(4) Fixing Method": {
    "p": [
      "Fixing the error.",
      "Since HSClientProtocolPBClientImpl extends from MRClientProtocalPBClientImpl, the latter needs to be patched.",
      "",
      "",
      "public classHSClientProtocolPBClientImplextendsMRClientProtocolPBClientImpl",
      "",
      "implementsHSClientProtocol {",
      "",
      "publicHSClientProtocolPBClientImpl(longclientVersion,",
      "",
      "InetSocketAddress addr, Configuration conf)throwsIOException {",
      "",
      "super();",
      "",
      "RPC.setProtocolEngine(conf, HSClientProtocolPB.class,",
      "",
      "ProtobufRpcEngine.class);",
      "",
      "proxy= (HSClientProtocolPB)RPC.getProxy(",
      "",
      "HSClientProtocolPB.class, clientVersion, addr, conf);",
      "",
      "}",
      "",
      "}",
      "",
      "The fixed file is not on the stack trace.",
      "â€¢hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-common/src/main/java/",
      "org/apache/hadoop/mapreduce/v2/api/impl/pb/client/MRClientProtocolPBClientImpl.java",
      "+import java.io.Closeable;",
      "import java.io.IOException;",
      "import java.net.InetSocketAddress;",
      "@@ -101,7 +102,8 @@",
      "import com.google.protobuf.ServiceException;",
      "-public class MRClientProtocolPBClientImpl implements MRClientProtocol {",
      "+public class MRClientProtocolPBClientImpl implements MRClientProtocol,",
      "+ Closeable {",
      "protected MRClientProtocolPB proxy;",
      "",
      "@@ -118,6 +120,13 @@ public InetSocketAddress getConnectAddress() {",
      "}",
      "@Override",
      "+ public void close() {",
      "+ if (this.proxy != null) {",
      "+ RPC.stopProxy(this.proxy);",
      "+ }",
      "+ }",
      "+",
      "+ @Override",
      "public GetJobReportResponse getJobReport(GetJobReportRequest request)",
      "throws YarnRemoteException {",
      "GetJobReportRequestProto requestProto = ((GetJobReportRequestPBImpl)request).getProto();"
    ]
  },
  "(5) How many nodes are involved in the patch": {
    "p": [
      "JobClient",
      "",
      "",
      "",
      ""
    ]
  }
}